// ===========================
// CONFIGURATION & CONSTANTS
// ===========================

// Office Location (Hardcoded) - Your actual office coordinates
const OFFICE_LOCATION = {
    latitude: 8.1848089,   // Your office location from Google Maps
    longitude: 77.3948716, // Your office location from Google Maps
    radius: 5              // 5 meters radius - strict geo-fencing
};

// EmailJS Configuration - Replace with your actual credentials
const EMAILJS_CONFIG = {
    serviceID: 'YOUR_SERVICE_ID',      // Replace with your EmailJS Service ID
    templateID: 'YOUR_TEMPLATE_ID',    // Replace with your EmailJS Template ID
    publicKey: 'YOUR_PUBLIC_KEY'       // Replace with your EmailJS Public Key
};

// Time Restrictions
const TIME_RESTRICTIONS = {
    checkIn: { start: '08:30', end: '10:00' },   // Check-in: 8:30 AM - 10:00 AM
    checkOut: { start: '17:00', end: '19:00' }   // Check-out: 5:00 PM - 7:00 PM
};

// ===========================
// GLOBAL VARIABLES
// ===========================
let currentPosition = null;
let distanceFromOffice = null;
let isInsideOffice = false;
let currentFilter = 'daily';

// IndexedDB variables
let db = null;
const DB_NAME = 'AttendanceDB';
const DB_VERSION = 1;
const STORE_NAME = 'attendanceRecords';

// ===========================
// DOM ELEMENTS
// ===========================
const elements = {
    employeeSelect: document.getElementById('employeeSelect'),
    btnCheckIn: document.getElementById('btnCheckIn'),
    btnCheckOut: document.getElementById('btnCheckOut'),
    messageBox: document.getElementById('messageBox'),
    currentDate: document.getElementById('currentDate'),
    currentTime: document.getElementById('currentTime'),
    distanceDisplay: document.getElementById('distanceDisplay'),
    locationStatus: document.getElementById('locationStatus'),
    statusIcon: document.getElementById('statusIcon'),
    statusText: document.getElementById('statusText'),
    attendanceTableBody: document.getElementById('attendanceTableBody'),
    filterButtons: document.querySelectorAll('.filter-btn'),
    btnExportCSV: document.getElementById('btnExportCSV'),
    btnExportExcel: document.getElementById('btnExportExcel'),
    summaryJohn: document.getElementById('summaryJohn'),
    summaryJane: document.getElementById('summaryJane')
};

// ===========================
// INITIALIZATION
// ===========================
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Attendance System Starting...');
    verifyStorageAvailability();
    initializeEmailJS();
    startLocationTracking();
    startClock();
    loadAttendanceData();
    setupEventListeners();
    updateButtonStates();
    logStorageStatus();
});

/**
 * Verify localStorage is available and working
 */
function verifyStorageAvailability() {
    try {
        const testKey = '__storage_test__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        console.log('‚úÖ LocalStorage is available and working');
    } catch (error) {
        console.error('‚ùå LocalStorage is not available!');
        alert('WARNING: Browser storage is disabled! Attendance data will not be saved.\n\nPlease enable cookies/storage in browser settings.');
    }
}

/**
 * Log current storage status for debugging
 */
function logStorageStatus() {
    const records = getAttendanceRecords();
    const lastSave = localStorage.getItem('attendanceRecords_lastSave');
    
    console.log('üìä Storage Status:');
    console.log('  - Total Records:', records.length);
    console.log('  - Last Save:', lastSave || 'Never');
    console.log('  - Has Backup:', !!localStorage.getItem('attendanceRecords_backup'));
    
    if (records.length > 0) {
        console.log('  - Employees:', [...new Set(records.map(r => r.employee))]);
        console.log('  - Date Range:', 
            records.length > 0 ? 
            `${records[0].date} to ${records[records.length - 1].date}` : 
            'N/A'
        );
    }
}

// ===========================
// INDEXEDDB DATABASE FUNCTIONS
// ===========================

/**
 * Initialize IndexedDB database
 */
function initializeDatabase() {
    return new Promise((resolve, reject) => {
        // Check if IndexedDB is supported
        if (!window.indexedDB) {
            console.error('IndexedDB not supported. Falling back to localStorage.');
            resolve();
            return;
        }

        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => {
            console.error('Database failed to open:', request.error);
            reject(request.error);
        };

        request.onsuccess = () => {
            db = request.result;
            console.log('‚úÖ Database opened successfully');
            console.log('Database name:', DB_NAME);
            console.log('Database version:', DB_VERSION);
            
            // Migrate data from localStorage if exists
            migrateFromLocalStorage();
            resolve();
        };

        // Create database schema
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            console.log('Creating database schema...');

            // Create object store for attendance records
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const objectStore = db.createObjectStore(STORE_NAME, { 
                    keyPath: 'id', 
                    autoIncrement: true 
                });
                
                // Create indexes for efficient querying
                objectStore.createIndex('employee', 'employee', { unique: false });
                objectStore.createIndex('date', 'date', { unique: false });
                objectStore.createIndex('employeeDate', ['employee', 'date'], { unique: true });
                
                console.log('‚úÖ Database schema created');
            }
        };
    });
}

/**
 * Migrate existing localStorage data to IndexedDB
 */
function migrateFromLocalStorage() {
    try {
        const localData = localStorage.getItem('attendanceRecords');
        if (localData) {
            const records = JSON.parse(localData);
            console.log(`Migrating ${records.length} records from localStorage to database...`);
            
            records.forEach(record => {
                saveAttendanceRecordToDB(record, false); // Don't show messages during migration
            });
            
            console.log('‚úÖ Data migration completed');
            // Keep localStorage as backup
        }
    } catch (error) {
        console.error('Migration error:', error);
    }
}

/**
 * Save attendance record to IndexedDB
 */
function saveAttendanceRecordToDB(record, showMessage = true) {
    return new Promise((resolve, reject) => {
        if (!db) {
            // Fallback to localStorage
            saveToLocalStorage(record);
            resolve();
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.add(record);

        request.onsuccess = () => {
            if (showMessage) {
                console.log('‚úÖ Record saved to database:', record);
            }
            // Also backup to localStorage
            saveToLocalStorage(record);
            resolve(request.result);
        };

        request.onerror = () => {
            console.error('Failed to save record:', request.error);
            // Try updating if it already exists
            updateAttendanceRecordInDB(record).then(resolve).catch(reject);
        };
    });
}

/**
 * Update existing attendance record in IndexedDB
 */
function updateAttendanceRecordInDB(record) {
    return new Promise((resolve, reject) => {
        if (!db) {
            updateInLocalStorage(record);
            resolve();
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(STORE_NAME);
        const index = objectStore.index('employeeDate');
        const request = index.get([record.employee, record.date]);

        request.onsuccess = () => {
            const existingRecord = request.result;
            if (existingRecord) {
                // Update existing record
                existingRecord.outTime = record.outTime;
                const updateRequest = objectStore.put(existingRecord);
                
                updateRequest.onsuccess = () => {
                    console.log('‚úÖ Record updated in database');
                    updateInLocalStorage(record);
                    resolve();
                };
                
                updateRequest.onerror = () => {
                    console.error('Failed to update record:', updateRequest.error);
                    reject(updateRequest.error);
                };
            } else {
                resolve();
            }
        };

        request.onerror = () => {
            console.error('Failed to find record:', request.error);
            reject(request.error);
        };
    });
}

/**
 * Get all attendance records from IndexedDB
 */
function getAttendanceRecordsFromDB() {
    return new Promise((resolve, reject) => {
        if (!db) {
            // Fallback to localStorage
            const records = getFromLocalStorage();
            resolve(records);
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.getAll();

        request.onsuccess = () => {
            const records = request.result || [];
            console.log(`üìä Retrieved ${records.length} records from database`);
            resolve(records);
        };

        request.onerror = () => {
            console.error('Failed to retrieve records:', request.error);
            // Fallback to localStorage
            const records = getFromLocalStorage();
            resolve(records);
        };
    });
}

/**
 * Get today's record for specific employee from IndexedDB
 */
function getTodayRecordFromDB(employee) {
    return new Promise((resolve, reject) => {
        if (!db) {
            const record = getTodayFromLocalStorage(employee);
            resolve(record);
            return;
        }

        const today = getCurrentDate();
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const objectStore = transaction.objectStore(STORE_NAME);
        const index = objectStore.index('employeeDate');
        const request = index.get([employee, today]);

        request.onsuccess = () => {
            resolve(request.result || null);
        };

        request.onerror = () => {
            console.error('Failed to get today record:', request.error);
            const record = getTodayFromLocalStorage(employee);
            resolve(record);
        };
    });
}

// ===========================
// LOCALSTORAGE FALLBACK FUNCTIONS
// ===========================

function saveToLocalStorage(record) {
    try {
        const records = getFromLocalStorage();
        const exists = records.findIndex(r => r.employee === record.employee && r.date === record.date);
        if (exists === -1) {
            records.push(record);
            localStorage.setItem('attendanceRecords', JSON.stringify(records));
        }
    } catch (error) {
        console.error('LocalStorage save error:', error);
    }
}

function updateInLocalStorage(record) {
    try {
        const records = getFromLocalStorage();
        const index = records.findIndex(r => r.employee === record.employee && r.date === record.date);
        if (index !== -1) {
            records[index] = record;
            localStorage.setItem('attendanceRecords', JSON.stringify(records));
        }
    } catch (error) {
        console.error('LocalStorage update error:', error);
    }
}

function getFromLocalStorage() {
    try {
        const records = localStorage.getItem('attendanceRecords');
        return records ? JSON.parse(records) : [];
    } catch (error) {
        console.error('LocalStorage get error:', error);
        return [];
    }
}

function getTodayFromLocalStorage(employee) {
    const records = getFromLocalStorage();
    const today = getCurrentDate();
    return records.find(r => r.employee === employee && r.date === today);
}

// Initialize EmailJS
function initializeEmailJS() {
    // Skip if not configured
    if (EMAILJS_CONFIG.publicKey === 'YOUR_PUBLIC_KEY') {
        console.log('EmailJS not configured - attendance will work without email notifications');
        return;
    }
    
    try {
        emailjs.init(EMAILJS_CONFIG.publicKey);
        console.log('EmailJS initialized successfully');
    } catch (error) {
        console.error('EmailJS initialization failed:', error);
        console.log('Attendance will work without email notifications');
    }
}

// ===========================
// GEOLOCATION & DISTANCE CALCULATION
// ===========================

/**
 * Start tracking user's location continuously
 */
function startLocationTracking() {
    if (!navigator.geolocation) {
        updateLocationStatus('error', '‚ùå', 'Geolocation not supported by browser');
        disableAttendanceButtons();
        return;
    }

    // Get initial position
    navigator.geolocation.getCurrentPosition(
        handleLocationSuccess,
        handleLocationError,
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );

    // Watch position continuously
    navigator.geolocation.watchPosition(
        handleLocationSuccess,
        handleLocationError,
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

/**
 * Handle successful location retrieval
 */
function handleLocationSuccess(position) {
    currentPosition = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude
    };

    // Calculate distance from office
    distanceFromOffice = calculateDistance(
        currentPosition.latitude,
        currentPosition.longitude,
        OFFICE_LOCATION.latitude,
        OFFICE_LOCATION.longitude
    );

    // Update distance display
    elements.distanceDisplay.textContent = `${distanceFromOffice.toFixed(2)} m`;

    // Check if inside office radius
    isInsideOffice = distanceFromOffice <= OFFICE_LOCATION.radius;

    if (isInsideOffice) {
        updateLocationStatus('inside', '‚úÖ', `Inside office area (${distanceFromOffice.toFixed(2)}m)`);
    } else {
        updateLocationStatus('outside', '‚õî', `Outside office area (${distanceFromOffice.toFixed(2)}m away)`);
    }

    updateButtonStates();
}

/**
 * Handle location retrieval error
 */
function handleLocationError(error) {
    let errorMessage = '';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage = 'Location permission denied. Please enable location access.';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage = 'Location information unavailable.';
            break;
        case error.TIMEOUT:
            errorMessage = 'Location request timed out.';
            break;
        default:
            errorMessage = 'Unknown error occurred.';
    }

    updateLocationStatus('error', '‚ùå', errorMessage);
    disableAttendanceButtons();
    console.error('Geolocation error:', error);
}

/**
 * Calculate distance between two coordinates using Haversine formula
 * Returns distance in meters
 */
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in meters
    const œÜ1 = lat1 * Math.PI / 180;
    const œÜ2 = lat2 * Math.PI / 180;
    const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
    const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c; // Distance in meters
}

/**
 * Update location status banner
 */
function updateLocationStatus(status, icon, text) {
    elements.locationStatus.className = `status-banner ${status}`;
    elements.statusIcon.textContent = icon;
    elements.statusText.textContent = text;
}

// ===========================
// TIME & DATE FUNCTIONS
// ===========================

/**
 * Start the real-time clock
 */
function startClock() {
    updateDateTime();
    setInterval(updateDateTime, 1000);
}

/**
 * Update date and time display
 */
function updateDateTime() {
    const now = new Date();
    
    // Format date
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    elements.currentDate.textContent = now.toLocaleDateString('en-US', dateOptions);
    
    // Format time
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
    elements.currentTime.textContent = now.toLocaleTimeString('en-US', timeOptions);
}

/**
 * Get current date in YYYY-MM-DD format
 */
function getCurrentDate() {
    const now = new Date();
    return now.toISOString().split('T')[0];
}

/**
 * Get current time in HH:MM:SS format
 */
function getCurrentTime() {
    const now = new Date();
    return now.toTimeString().split(' ')[0];
}

/**
 * Check if current time is within allowed time range
 */
function isTimeAllowed(type) {
    const now = new Date();
    const currentTime = now.toTimeString().slice(0, 5); // HH:MM
    
    const restriction = TIME_RESTRICTIONS[type];
    return currentTime >= restriction.start && currentTime <= restriction.end;
}

// ===========================
// ATTENDANCE LOGIC
// ===========================

/**
 * Setup event listeners
 */
function setupEventListeners() {
    // Employee selection change
    elements.employeeSelect.addEventListener('change', updateButtonStates);
    
    // Check-in button
    elements.btnCheckIn.addEventListener('click', handleCheckIn);
    
    // Check-out button
    elements.btnCheckOut.addEventListener('click', handleCheckOut);
    
    // Filter buttons
    elements.filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            elements.filterButtons.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.filter;
            loadAttendanceData();
        });
    });
    
    // Export buttons
    elements.btnExportCSV.addEventListener('click', exportToCSV);
    elements.btnExportExcel.addEventListener('click', exportToExcel);
    
    // Backup and Restore buttons
    const btnBackupData = document.getElementById('btnBackupData');
    const btnRestoreData = document.getElementById('btnRestoreData');
    const fileRestore = document.getElementById('fileRestore');
    
    if (btnBackupData) {
        btnBackupData.addEventListener('click', backupAttendanceData);
    }
    
    if (btnRestoreData) {
        btnRestoreData.addEventListener('click', () => fileRestore.click());
    }
    
    if (fileRestore) {
        fileRestore.addEventListener('change', restoreAttendanceData);
    }
}

/**
 * Update button states based on conditions
 */
async function updateButtonStates() {
    const employee = elements.employeeSelect.value;
    
    if (!employee) {
        disableAttendanceButtons();
        return;
    }

    // Check if employee has already checked in today
    const todayRecord = await getTodayRecordFromDB(employee);
    
    // Check IN button conditions
    const canCheckIn = isInsideOffice && 
                       isTimeAllowed('checkIn') && 
                       !todayRecord;
    
    elements.btnCheckIn.disabled = !canCheckIn;
    
    // Check OUT button conditions
    const canCheckOut = isInsideOffice && 
                        isTimeAllowed('checkOut') && 
                        todayRecord && 
                        !todayRecord.outTime;
    
    elements.btnCheckOut.disabled = !canCheckOut;
}

/**
 * Disable all attendance buttons
 */
function disableAttendanceButtons() {
    elements.btnCheckIn.disabled = true;
    elements.btnCheckOut.disabled = true;
}

/**
 * Handle Check-In
 */
async function handleCheckIn() {
    const employee = elements.employeeSelect.value;
    
    if (!employee) {
        showMessage('Please select an employee', 'error');
        return;
    }

    if (!isInsideOffice) {
        showMessage('You are outside office location. Cannot mark attendance.', 'error');
        return;
    }

    if (!isTimeAllowed('checkIn')) {
        showMessage('Check-in is only allowed between 8:30 AM - 10:00 AM', 'error');
        return;
    }

    const todayRecord = await getTodayRecordFromDB(employee);
    if (todayRecord) {
        showMessage('You have already checked in today', 'error');
        return;
    }

    // Create attendance record
    const record = {
        employee: employee,
        date: getCurrentDate(),
        inTime: getCurrentTime(),
        outTime: null,
        distance: distanceFromOffice.toFixed(2),
        status: 'Inside'
    };

    // Save to database
    await saveAttendanceRecordToDB(record);
    
    // Send email notification
    sendEmailNotification(employee, 'IN', record);
    
    // Update UI
    showMessage(`‚úÖ Check-in successful for ${employee} - Data saved to database`, 'success');
    await loadAttendanceData();
    updateButtonStates();
}

/**
 * Handle Check-Out
 */
async function handleCheckOut() {
    const employee = elements.employeeSelect.value;
    
    if (!employee) {
        showMessage('Please select an employee', 'error');
        return;
    }

    if (!isInsideOffice) {
        showMessage('You are outside office location. Cannot mark attendance.', 'error');
        return;
    }

    if (!isTimeAllowed('checkOut')) {
        showMessage('Check-out is only allowed between 5:00 PM - 7:00 PM', 'error');
        return;
    }

    const todayRecord = await getTodayRecordFromDB(employee);
    if (!todayRecord) {
        showMessage('Please check-in first', 'error');
        return;
    }

    if (todayRecord.outTime) {
        showMessage('You have already checked out today', 'error');
        return;
    }

    // Update record with check-out time
    todayRecord.outTime = getCurrentTime();
    await updateAttendanceRecordInDB(todayRecord);
    
    // Send email notification
    sendEmailNotification(employee, 'OUT', todayRecord);
    
    // Update UI
    showMessage(`‚úÖ Check-out successful for ${employee} - Data saved to database`, 'success');
    await loadAttendanceData();
    updateButtonStates();
}

// ===========================
// DATA STORAGE (LocalStorage)
// ===========================

/**
 * Save attendance record to localStorage with backup
 */
function saveAttendanceRecord(record) {
    try {
        const records = getAttendanceRecords();
        records.push(record);
        const jsonData = JSON.stringify(records);
        
        // Save to main storage
        localStorage.setItem('attendanceRecords', jsonData);
        
        // Create backup copy
        localStorage.setItem('attendanceRecords_backup', jsonData);
        
        // Save timestamp of last save
        localStorage.setItem('attendanceRecords_lastSave', new Date().toISOString());
        
        console.log('‚úÖ Attendance record saved successfully');
        console.log('Total records:', records.length);
    } catch (error) {
        console.error('‚ùå Failed to save attendance record:', error);
        alert('Error saving attendance! Please check storage permissions.');
    }
}

/**
 * Update existing attendance record with backup
 */
function updateAttendanceRecord(updatedRecord) {
    try {
        const records = getAttendanceRecords();
        const index = records.findIndex(r => 
            r.employee === updatedRecord.employee && 
            r.date === updatedRecord.date
        );
        
        if (index !== -1) {
            records[index] = updatedRecord;
            const jsonData = JSON.stringify(records);
            
            // Save to main storage
            localStorage.setItem('attendanceRecords', jsonData);
            
            // Create backup copy
            localStorage.setItem('attendanceRecords_backup', jsonData);
            
            // Save timestamp
            localStorage.setItem('attendanceRecords_lastSave', new Date().toISOString());
            
            console.log('‚úÖ Attendance record updated successfully');
        }
    } catch (error) {
        console.error('‚ùå Failed to update attendance record:', error);
        alert('Error updating attendance! Please check storage permissions.');
    }
}

/**
 * Get all attendance records from localStorage with recovery
 */
function getAttendanceRecords() {
    try {
        // Try to get main records
        let records = localStorage.getItem('attendanceRecords');
        
        if (records) {
            return JSON.parse(records);
        }
        
        // If main is empty, try backup
        console.log('‚ö†Ô∏è Main storage empty, checking backup...');
        const backup = localStorage.getItem('attendanceRecords_backup');
        
        if (backup) {
            console.log('‚úÖ Restored from backup!');
            // Restore backup to main
            localStorage.setItem('attendanceRecords', backup);
            return JSON.parse(backup);
        }
        
        // No records found
        console.log('‚ÑπÔ∏è No attendance records found (new system)');
        return [];
        
    } catch (error) {
        console.error('‚ùå Error reading attendance records:', error);
        
        // Try backup as last resort
        try {
            const backup = localStorage.getItem('attendanceRecords_backup');
            if (backup) {
                console.log('‚úÖ Recovered from backup after error');
                return JSON.parse(backup);
            }
        } catch (backupError) {
            console.error('‚ùå Backup also failed:', backupError);
        }
        
        return [];
    }
}

/**
 * Get today's record for specific employee
 */
function getTodayRecord(employee) {
    const records = getAttendanceRecords();
    const today = getCurrentDate();
    return records.find(r => r.employee === employee && r.date === today);
}

/**
 * Filter records based on timeline
 */
function filterRecordsByTimeline(records, timeline) {
    const now = new Date();
    
    switch(timeline) {
        case 'daily':
            return records.filter(r => r.date === getCurrentDate());
        
        case 'weekly':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return records.filter(r => new Date(r.date) >= weekAgo);
        
        case 'monthly':
            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            return records.filter(r => new Date(r.date) >= monthAgo);
        
        case 'yearly':
            const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            return records.filter(r => new Date(r.date) >= yearAgo);
        
        default:
            return records;
    }
}

// ===========================
// EMAIL NOTIFICATION
// ===========================

/**
 * Send email notification using EmailJS
 */
function sendEmailNotification(employee, action, record) {
    // Check if EmailJS is configured
    if (EMAILJS_CONFIG.serviceID === 'YOUR_SERVICE_ID' || 
        EMAILJS_CONFIG.templateID === 'YOUR_TEMPLATE_ID' ||
        EMAILJS_CONFIG.publicKey === 'YOUR_PUBLIC_KEY') {
        console.log('EmailJS not configured. Skipping email notification.');
        console.log('Attendance marked successfully without email.');
        return;
    }

    try {
        const emailParams = {
            employee_name: employee,
            action: action,
            date: record.date,
            time: action === 'IN' ? record.inTime : record.outTime,
            distance: record.distance,
            status: record.status,
            location_lat: currentPosition ? currentPosition.latitude.toFixed(6) : 'N/A',
            location_lng: currentPosition ? currentPosition.longitude.toFixed(6) : 'N/A'
        };

        // Send email via EmailJS
        emailjs.send(
            EMAILJS_CONFIG.serviceID,
            EMAILJS_CONFIG.templateID,
            emailParams
        )
        .then((response) => {
            console.log('Email sent successfully:', response);
        })
        .catch((error) => {
            console.error('Email sending failed:', error);
            // Don't show error to user as attendance is already marked
        });
    } catch (error) {
        console.error('Email notification error:', error);
    }
}

// ===========================
// UI DISPLAY FUNCTIONS
// ===========================

/**
 * Show message to user
 */
function showMessage(message, type) {
    elements.messageBox.textContent = message;
    elements.messageBox.className = `message-box show ${type}`;
    
    setTimeout(() => {
        elements.messageBox.classList.remove('show');
    }, 5000);
}

/**
 * Load and display attendance data
 */
async function loadAttendanceData() {
    const allRecords = await getAttendanceRecordsFromDB();
    const filteredRecords = filterRecordsByTimeline(allRecords, currentFilter);
    
    // Update table
    if (filteredRecords.length === 0) {
        elements.attendanceTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="no-data">No attendance records found for ${currentFilter} view</td>
            </tr>
        `;
    } else {
        elements.attendanceTableBody.innerHTML = filteredRecords
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .map(record => `
                <tr>
                    <td>${record.employee}</td>
                    <td>${formatDate(record.date)}</td>
                    <td>${record.inTime || '--'}</td>
                    <td>${record.outTime || '--'}</td>
                    <td>${record.distance}</td>
                    <td class="status-${record.status.toLowerCase()}">${record.status}</td>
                </tr>
            `).join('');
    }
    
    // Update summary
    updateSummary(allRecords);
}

/**
 * Format date for display
 */
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

/**
 * Update attendance summary
 */
function updateSummary(records) {
    // Count unique dates for each employee
    const johnDays = new Set(records.filter(r => r.employee === 'John Doe').map(r => r.date)).size;
    const janeDays = new Set(records.filter(r => r.employee === 'Jane Smith').map(r => r.date)).size;
    
    elements.summaryJohn.textContent = `${johnDays} days`;
    elements.summaryJane.textContent = `${janeDays} days`;
}

// ===========================
// EXPORT FUNCTIONS
// ===========================

/**
 * Export to CSV
 */
async function exportToCSV() {
    const allRecords = await getAttendanceRecordsFromDB();
    const filteredRecords = filterRecordsByTimeline(allRecords, currentFilter);
    
    if (filteredRecords.length === 0) {
        showMessage('No data to export', 'error');
        return;
    }

    // Create CSV content
    let csv = 'Employee,Date,IN Time,OUT Time,Distance (m),Status\n';
    
    filteredRecords.forEach(record => {
        csv += `${record.employee},${record.date},${record.inTime || '--'},${record.outTime || '--'},${record.distance},${record.status}\n`;
    });

    // Download CSV
    downloadFile(csv, `attendance_${currentFilter}_${getCurrentDate()}.csv`, 'text/csv');
    showMessage('CSV exported successfully', 'success');
}

/**
 * Export to Excel using SheetJS
 */
async function exportToExcel() {
    const allRecords = await getAttendanceRecordsFromDB();
    const filteredRecords = filterRecordsByTimeline(allRecords, currentFilter);
    
    if (filteredRecords.length === 0) {
        showMessage('No data to export', 'error');
        return;
    }

    // Prepare data for Excel
    const data = filteredRecords.map(record => ({
        'Employee': record.employee,
        'Date': record.date,
        'IN Time': record.inTime || '--',
        'OUT Time': record.outTime || '--',
        'Distance (m)': record.distance,
        'Status': record.status
    }));

    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Attendance');

    // Generate Excel file and download
    XLSX.writeFile(wb, `attendance_${currentFilter}_${getCurrentDate()}.xlsx`);
    showMessage('Excel exported successfully', 'success');
}

/**
 * Download file helper
 */
function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// ===========================
// BACKUP & RESTORE FUNCTIONS
// ===========================

/**
 * Backup all attendance data to a JSON file
 */
function backupAttendanceData() {
    try {
        const allRecords = getAttendanceRecords();
        
        if (allRecords.length === 0) {
            showMessage('No data to backup', 'error');
            return;
        }

        const backupData = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            totalRecords: allRecords.length,
            records: allRecords
        };

        const jsonString = JSON.stringify(backupData, null, 2);
        const filename = `attendance_backup_${getCurrentDate()}_${Date.now()}.json`;
        
        downloadFile(jsonString, filename, 'application/json');
        
        showMessage(`‚úÖ Backup created successfully! (${allRecords.length} records)`, 'success');
        console.log('üì¶ Backup created:', filename);
    } catch (error) {
        console.error('‚ùå Backup failed:', error);
        showMessage('Backup failed! Check console for details.', 'error');
    }
}

/**
 * Restore attendance data from a JSON backup file
 */
function restoreAttendanceData(event) {
    const file = event.target.files[0];
    
    if (!file) {
        return;
    }

    if (!file.name.endsWith('.json')) {
        showMessage('Please select a valid JSON backup file', 'error');
        return;
    }

    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const backupData = JSON.parse(e.target.result);
            
            // Validate backup data structure
            if (!backupData.records || !Array.isArray(backupData.records)) {
                throw new Error('Invalid backup file format');
            }

            // Ask for confirmation
            const currentRecords = getAttendanceRecords();
            const message = `Restore backup?\n\n` +
                          `Current records: ${currentRecords.length}\n` +
                          `Backup records: ${backupData.records.length}\n` +
                          `Backup date: ${new Date(backupData.exportDate).toLocaleString()}\n\n` +
                          `This will ADD backup records to existing data.`;
            
            if (!confirm(message)) {
                showMessage('Restore cancelled', 'info');
                return;
            }

            // Merge records (avoid duplicates)
            const existingRecords = getAttendanceRecords();
            const newRecords = backupData.records;
            
            // Create a Set of existing record keys
            const existingKeys = new Set(
                existingRecords.map(r => `${r.employee}_${r.date}`)
            );
            
            // Add only non-duplicate records
            let addedCount = 0;
            newRecords.forEach(record => {
                const key = `${record.employee}_${record.date}`;
                if (!existingKeys.has(key)) {
                    existingRecords.push(record);
                    addedCount++;
                }
            });

            // Save merged data
            const jsonData = JSON.stringify(existingRecords);
            localStorage.setItem('attendanceRecords', jsonData);
            localStorage.setItem('attendanceRecords_backup', jsonData);
            localStorage.setItem('attendanceRecords_lastSave', new Date().toISOString());

            showMessage(`‚úÖ Restored ${addedCount} new records! (${existingRecords.length} total)`, 'success');
            console.log('üì• Data restored successfully');
            
            // Reload the display
            loadAttendanceData();
            
        } catch (error) {
            console.error('‚ùå Restore failed:', error);
            showMessage('Restore failed! Invalid backup file.', 'error');
        }
    };
    
    reader.onerror = function() {
        showMessage('Failed to read backup file', 'error');
    };
    
    reader.readAsText(file);
    
    // Reset file input
    event.target.value = '';
}

// ===========================
// CONSOLE LOG FOR DEBUGGING
// ===========================
console.log('Attendance Management System Loaded');
console.log('Office Location:', OFFICE_LOCATION);
console.log('Time Restrictions:', TIME_RESTRICTIONS);
